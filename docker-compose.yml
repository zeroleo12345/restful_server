version: '3.5'

services:
  web:
    container_name: restful_server_web
    build:
       context: .
       dockerfile: ./Dockerfile
    depends_on:
      - mysql
      - redis
    ports:      # 外部端口:docker内部端口
      - "8000:8000"       # 只限于使用docker-compse up时, 会映射到8000端口, 而生产会映射到80端口
    #env_file:
      #- docker.env
    environment:
      SECRET_KEY: "${SECRET_KEY}"
      DJANGO_SETTINGS_MODULE: "${DJANGO_SETTINGS_MODULE}"
      REDIS_URI: "${REDIS_URI}"
      DATABASE_URI: "${DATABASE_URI}"
      DEBUG: "${DEBUG}"
      ENVIRONMENT: "${ENVIRONMENT}"

      API_SERVER_URL: "${API_SERVER_URL}"   # API服务器域名

      MP_WEB_URL: "${MP_WEB_URL}"   # 微信公众平台
      MP_APP_ID: "${MP_APP_ID}"     # 开发者ID
      MP_APP_SECRET: "${MP_APP_SECRET}"     # 开发者密码
      MP_TOKEN: "${MP_TOKEN}"   # 令牌
      MP_AES_KEY: "${MP_AES_KEY}"   # 消息加解密密钥

      # 微信商户平台
      MP_APP_KEY: "${MP_APP_KEY}"   # API密钥
      MP_MERCHANT_ID: "${MP_MERCHANT_ID}"   # 商户号
      MP_MERCHANT_CERT: "${MP_MERCHANT_CERT}"   # 商户证书路径
      MP_MERCHANT_KEY: "${MP_MERCHANT_KEY}"     # 商户证书私钥路径
      ## 未确定哪里获取
      MP_SUB_MERCHANT_ID: "${MP_SUB_MERCHANT_ID}"   # 可选. 子商户号, 受理模式下必填

      # 公众号客服
      #MP_KF_ACCOUNT: "${MP_KF_ACCOUNT}"
      #MP_KF_NICKNAME: "${MP_KF_NICKNAME}"
      #MP_KF_PASSWORD: "${MP_KF_PASSWORD}"
    volumes:        # 挂载盘(多用于输出程序文件, 日志等)
      - .:/app     # 机路径:docker内部路径.(把主机下的src目录挂在到docker下, 实现边开发, 边调试)
      #- ./runtest:/bin/runtest
    #entrypoint: /app/bin/restful_server_deamon.sh      # docker启动期执行程序
    #entrypoint: sh      # 用于调试
    #command: dockerize -wait tcp://mysql:3306 -timeout 10s
    tty: true
    networks:
      - pppoe_system


  redis:
    container_name: restful_server_redis
    image: redis:alpine
    networks:
      - pppoe_system


  mysql:
    container_name: restful_server_mysql
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: 'root'
      MYSQL_DATABASE: 'trade'
    ports:
      - "33333:3306"     # 用于sequel pro连接
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --default-time-zone=+08:00      # 同时在django连接时, 指定时区
    networks:
      - pppoe_system


networks:
  pppoe_system:
    name: pppoe_system_network_name
